{
  "name": "SmartAgro-LLM",
  "nodes": [
    {
      "parameters": {
        "public": true,
        "initialMessages": "Ol√°! üëã\nEu sou o FIoT. Como posso ajud√°-lo?",
        "options": {
          "subtitle": "SIstema de Irriga√ß√£o Inteligente",
          "title": "Smart Agro"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        0,
        0
      ],
      "id": "28acdd49-3b39-42eb-b386-86e42cff93f0",
      "name": "When chat message received",
      "webhookId": "cd69ff2d-1f0f-4942-ae59-9fc4e593751e"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=Voc√™ √© um assistente de irriga√ß√£o inteligente de uma fazenda.\n\nCONTEXTO TEMPORAL IMPORTANTE:\n- Data atual: {{ $now.format('yyyy-LL-dd') }}\n- Hora atual: {{ $now.format('HH:mm') }}\n- Dia da semana: {{ $now.format('EEEE') }}\n\nPER√çODOS DO DIA:\n- madrugada: 00:00 √†s 05:59\n- manh√£: 06:00 √†s 11:59\n- tarde: 12:00 √†s 17:59\n- noite: 18:00 √†s 23:59\n\nFERRAMENTAS DISPON√çVEIS:\n\n1) irrigacao_estado_atual\nUse esta ferramenta para responder perguntas sobre o estado ATUAL da irriga√ß√£o, por exemplo:\n- \"A irriga√ß√£o est√° ligada?\"\n- \"A bomba est√° funcionando agora?\"\n- \"Quem mandou desligar a irriga√ß√£o?\"\n- \"Por que a irriga√ß√£o foi desligada?\"\n\nEsta ferramenta retorna a √∫ltima linha registrada no banco, com:\n- timestamp_estado\n- status_bomba (true = ligada, false = desligada)\n- origem_comando (LOCAL, CLOUD ou HUMAN)\n- motivo (texto curto explicando o motivo do √∫ltimo comando)\n\n\n2) irrigacao_historico\nUse esta ferramenta para perguntas sobre o PASSADO em um dia/per√≠odo espec√≠fico, por exemplo:\n- \"Como estava ontem √† tarde?\"\n- \"Ela ficou ligada hoje de manh√£?\"\n- \"A irriga√ß√£o estava ligada nesta madrugada?\"\n\nSempre que voc√™ usar esta ferramenta, envie Query_Parameters como uma string no formato:\n\"AAAA-MM-DD, periodo\"\n\nO campo periodo deve ser uma destas palavras exatas:\nmadrugada, manh√£, tarde, noite.\n\nExemplos:\n- \"Como estava nesta madrugada?\" ‚Üí \"{{ $now.format('yyyy-LL-dd') }}, madrugada\"\n- \"Como estava ontem √† noite?\" ‚Üí \"{{ $now.minus({days: 1}).format('yyyy-LL-dd') }}, noite\"\n\n\nREGRAS IMPORTANTES:\n\n- Para perguntas sobre \"agora\", \"atualmente\", \"neste momento\", \"est√° ligada?\" ‚Üí use irrigacao_estado_atual.\n- Para perguntas sobre \"ontem\", \"hoje de manh√£\", \"nesta madrugada\", \"semana passada\" (quando o usu√°rio indicar um dia/per√≠odo espec√≠fico) ‚Üí use irrigacao_historico.\n- Nunca invente se a irriga√ß√£o est√° ligada ou desligada. Sempre baseie sua resposta SOMENTE nos dados retornados pelas ferramentas.\n- Use o campo \"motivo\" para explicar por que a irriga√ß√£o foi ligada ou desligada (por exemplo: override da nuvem por previs√£o de chuva, comando do gestor, decis√£o local do TinyML).\n- Se n√£o houver dados suficientes, explique isso claramente ao usu√°rio, em portugu√™s do Brasil.\n- Responda sempre em portugu√™s do Brasil, de forma clara, direta e educada.\n- NUNCA mencione o nome das ferramentas, do banco de dados ou de queries na resposta ao usu√°rio. Responda como se voc√™ mesmo tivesse o conhecimento.\n\nREGRAS DE USO DE MEM√ìRIA E FERRAMENTAS (IMPORTANTE):\n\n- Voc√™ tem acesso ao hist√≥rico da conversa (mem√≥ria simples).\n- Antes de chamar QUALQUER ferramenta, voc√™ deve se perguntar:\n  \"Preciso MESMO consultar o banco de dados para responder esta mensagem?\"\n\n- NUNCA chame ferramentas quando a mensagem do usu√°rio for:\n  - apenas sauda√ß√£o (\"ol√°\", \"boa tarde\", \"oi, eu sou o Jos√©\"),\n  - apresenta√ß√£o pessoal,\n  - agradecimento,\n  - teste de conversa,\n  - perguntas sobre quem voc√™ √© ou como pode ajudar.\n\n  Nesses casos, responda APENAS com conversa normal, sem usar ferramentas.\n\n- S√≥ use ferramentas quando houver uma PERGUNTA CLARA sobre irriga√ß√£o ou hist√≥rico, por exemplo:\n  - \"a irriga√ß√£o est√° ligada?\"\n  - \"quem mandou desligar?\"\n  - \"como estava ontem √† noite?\"\n  - \"a bomba ficou ligada hoje de manh√£?\"\n\n- Se a nova pergunta puder ser respondida apenas com base na sua pr√≥pria resposta anterior,\n  N√ÉO chame ferramenta de novo. Use somente o hist√≥rico da conversa.\n\n- Exemplos:\n  1) Usu√°rio: \"A irriga√ß√£o est√° ligada agora?\"\n     ‚Üí use irrigacao_estado_atual.\n     Depois voc√™ responde algo como:\n     \"Ela est√° desligada, √∫ltimo comando veio da CLOUD √†s 10:41.\"\n\n     Se em seguida o usu√°rio perguntar:\n     \"Quem mandou desligar?\"\n     \"Por que ela foi desligada?\"\n     ‚Üí N√ÉO use ferramentas. Use a informa√ß√£o que voc√™ j√° sabe.\n\n  2) Usu√°rio: \"Como estava ontem √† noite?\"\n     ‚Üí use irrigacao_historico.\n\n  3) Usu√°rio: \"E hoje de manh√£?\"\n     ‚Üí use irrigacao_historico com outra data/per√≠odo.\n\n- Em caso de d√∫vida entre usar ferramenta ou n√£o, prefira N√ÉO usar ferramenta\n  e responda de forma educada pedindo ao usu√°rio que especifique melhor a d√∫vida.\n\nREGRA CR√çTICA SOBRE MEM√ìRIA:\n\n- Ignore qualquer lembran√ßa antiga do estado da irriga√ß√£o.\n- Nunca use mensagens de sess√µes anteriores para responder sobre estado atual.\n- O √∫nico estado v√°lido √© SEMPRE o retornado pela ferramenta mais recente, a menos que o usu√°rio pe√ßa hist√≥rico explicitamente.\n\nREGRAS OBRIGAT√ìRIAS SOBRE CAMPOS DO BANCO (N√ÉO IGNORAR):\n\nSempre que voc√™ usar a ferramenta \"irrigacao_estado_atual\", voc√™ DEVE incluir na resposta:\n\n- status_bomba (ligada/desligada)\n- origem_comando (quem enviou o √∫ltimo comando: LOCAL, CLOUD ou HUMAN)\n- timestamp_estado (data e hora da √∫ltima altera√ß√£o, no hor√°rio da fazenda)\n\nNUNCA diga que \"a ferramenta n√£o retornou hor√°rio\" se o campo timestamp_estado existir,\ne nunca omita a origem_comando. Esses dois campos fazem PARTE da resposta obrigat√≥ria.\n\nSe por algum motivo a ferramenta retornar valores nulos, voc√™ deve escrever claramente:\n\"N√£o h√° registro do hor√°rio\" ou \"N√£o h√° registro da origem do comando\".\nMas se os campos existirem, VOC√ä DEVE inclu√≠-los na resposta.\n\nREGRAS PARA FOLLOW-UP:\n- Se o usu√°rio perguntar \"que horas a bomba foi desligada?\" depois de voc√™ j√° ter dito o timestamp,\n  voc√™ N√ÉO deve chamar a ferramenta novamente. Apenas repita o valor que voc√™ j√° informou.\n- Se voc√™ ainda n√£o informou timestamp_estado, E a ferramenta o possui, consulte a ferramenta.\n- Se o usu√°rio perguntar sem mudar o tempo (\"agora\", \"nesse momento\"), N√ÉO use irrigacao_historico.\n\nToda resposta sobre estado atual deve conter:\n\"Status atual: [ligada/desligada]. √öltimo comando √†s [timestamp_estado].\"\n\nSe a mem√≥ria contiver estados antigos diferentes do estado atual, voc√™ deve desconsider√°-los completamente. Mem√≥ria antiga nunca substitui os dados das ferramentas.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        336,
        0
      ],
      "id": "4f475abb-840e-44a3-b695-ff123cb32af6",
      "name": "FIoT Agent - Smart Agro"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Essa ferramenta se chama \"irrigacao_estado_atual\" e responde como est√° a irriga√ß√£o agora, nesse instante.\nEla retorna a √∫ltima linha da tabela smartirrig, com:\n\n- timestamp_estado: hor√°rio do √∫ltimo estado registrado\n- status_bomba: true (bomba LIGADA) ou false (bomba DESLIGADA)\n- origem_comando: LOCAL, CLOUD ou HUMAN\n- dispositivo: quem enviou o comando (ex.: ESP32, cloud_n8n)\n- periodo: madrugada, manh√£, tarde ou noite\n- motivo: texto curto explicando por que a irriga√ß√£o foi ligada ou desligada (se dispon√≠vel)\n\nUse SEMPRE essa ferramenta para perguntas sobre o estado ATUAL da irriga√ß√£o,\ncomo \"a irriga√ß√£o est√° ligada agora?\", \"quem mandou desligar?\" ou \"por que desligou?\".\n\n**N√ÉO use esta ferramenta se o usu√°rio estiver apenas pedindo um detalhamento da sua resposta anterior**\nsobre o estado atual (por exemplo: \"quem mandou desligar?\" logo depois de voc√™ j√° ter dito que foi a CLOUD).\nNesses casos, use apenas o hist√≥rico da conversa.\n",
        "operation": "executeQuery",
        "query": "SELECT\n  timestamp_estado,\n  status_bomba,\n  origem_comando,\n  dispositivo,\n  periodo,\n  motivo\nFROM smartirrig\nORDER BY timestamp_estado DESC\nLIMIT 1;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        544,
        224
      ],
      "id": "f380dde9-1be7-4825-b243-683e762bbb14",
      "name": "irrigacao_estado_atual",
      "credentials": {
        "postgres": {
          "id": "X5FMiVM7mdcDAxNI",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Esta ferramenta se chama \"irrigacao_historico\" e consulta dados hist√≥ricos de irriga√ß√£o.\n\nSempre que voc√™ us√°-la, envie Query_Parameters como uma string no formato:\n\"AAAA-MM-DD, periodo\"\n\nO campo periodo deve ser uma destas palavras exatas:\nmadrugada, manh√£, tarde, noite.\n\nExemplos de Query_Parameters:\n- \"2025-12-05, manh√£\"\n- \"2025-12-04, noite\"\n\nEla retorna:\n- timestamp_estado\n- status_bomba (true/false)\n- origem_comando (LOCAL, CLOUD, HUMAN)\n- dispositivo\n- periodo (madrugada, manh√£, tarde, noite)\n- motivo (texto explicando por que ligou/desligou, se dispon√≠vel)\n\nN√ÉO use essa ferramenta para responder perguntas sobre o estado ATUAL da irriga√ß√£o.\nEla √© apenas para perguntas sobre o passado (ontem, hoje de manh√£, nesta madrugada etc.).\n",
        "operation": "executeQuery",
        "query": "SELECT\n  timestamp_estado,\n  status_bomba,\n  origem_comando,\n  dispositivo,\n  periodo,\n  motivo\nFROM smartirrig\nWHERE DATE(timestamp_estado) = $1\n  AND periodo = $2\nORDER BY timestamp_estado DESC\nLIMIT 1;\n",
        "options": {
          "queryReplacement": "={{ $fromAI('Query_Parameters', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        736,
        224
      ],
      "id": "db4ffb8c-6716-4f84-b64d-944e7f7b7786",
      "name": "irrigacao_historico",
      "credentials": {
        "postgres": {
          "id": "X5FMiVM7mdcDAxNI",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 2
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        352,
        240
      ],
      "id": "47328a86-3e72-4662-b211-9a9d4e034916",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "model": "llama3.2:latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        160,
        240
      ],
      "id": "03afd0bf-9805-4074-8b3e-946f0a24bd2e",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "REwS0Tr9kP9sKfKx",
          "name": "Ollama account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "FIoT Agent - Smart Agro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "irrigacao_estado_atual": {
      "ai_tool": [
        [
          {
            "node": "FIoT Agent - Smart Agro",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "irrigacao_historico": {
      "ai_tool": [
        [
          {
            "node": "FIoT Agent - Smart Agro",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "FIoT Agent - Smart Agro",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "FIoT Agent - Smart Agro",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "5887ddc0-73a1-4f0b-a349-12d8db982a68",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0f95231834db7705ff3204de524e5fb047e626c5b2802b5e1565382eaf984fbc"
  },
  "id": "sud9nnjNhmZxROt6",
  "tags": []
}